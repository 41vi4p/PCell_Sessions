<!doctype html>
<html lang="en">

<head>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width,initial-scale=1" />
 <title>Dashboard - CRC Email Portal</title>
 <link rel="stylesheet" href="/static/styles.css">
 <style>
  /* small overrides */
 </style>
</head>

<body>
 <div class="app">
  <div class="topbar">
   <div class="logo">CRC Email Portal</div>
   <div class="toolbar">
    <button id="refreshBtn" title="Refresh">Refresh</button>
    <button id="logout" title="Logout">Logout</button>
   </div>
  </div>

  <div class="layout">
   <div class="sidebar">
    <div style="font-weight:700;margin-bottom:8px">Folders</div>
    <div class="folder active" data-folder="inbox">Inbox</div>
    <div class="folder" data-folder="starred">Starred</div>
    <div class="folder" data-folder="all">All Mail</div>
    <div style="height:12px"></div>
    <div class="footer-note">Read-only demo — send disabled</div>
   </div>

   <div class="main">
    <div class="list">
     <div class="search"><input id="search" placeholder="Search mail" /></div>
     <div id="mailList"></div>
    </div>
    <div class="viewer">
     <div style="display:flex;justify-content:space-between;align-items:center">
      <div id="userInfo" class="meta"></div>
      <div>
       <button id="markBtn" class="muted-btn">Mark Unread</button>
       <button id="openModal" class="muted-btn">Open in Modal</button>
      </div>
     </div>
     <div id="mailViewer" class="mail-body empty">Select an email to view</div>
    </div>
   </div>
  </div>
 </div>

 <div id="modalRoot" style="display:none"></div>

 <script>
  const token = localStorage.getItem('crc_token');
  const roll = localStorage.getItem('crc_roll');
  if (!token || !roll) {window.location.href = '/';}

  const state = {emails: [], selected: null, read: JSON.parse(localStorage.getItem('crc_read_' + roll) || '[]')};

  async function fetchEmails() {
   const res = await fetch('/api/get-emails', {headers: {'Authorization': 'Bearer ' + token}});
   if (!res.ok) {alert('Failed to load emails'); if (res.status === 401) window.location.href = '/'; return;}
   const data = await res.json();
   state.emails = data.emails || [];
   renderList();
   if (state.emails.length) selectEmail(state.emails[0].id);
  }

  function renderList(filter) {
   const container = document.getElementById('mailList');
   container.innerHTML = '';
   const q = (filter || '').toLowerCase();
   const items = state.emails.filter(e => {
    if (!q) return true;
    return (e.subject + ' ' + e.sender + ' ' + (e.body || '')).toLowerCase().includes(q);
   });
   if (items.length === 0) {container.innerHTML = '<div class="empty">No messages</div>'; return;}
   items.forEach(e => {
    const div = document.createElement('div');
    div.className = 'mail-item ' + (state.read.includes(e.id) ? '' : 'unread');
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(e.subject)}</strong><div class="mail-sub">${e.sender} • ${e.timestamp}</div></div><div style="color:var(--muted)">...</div></div>`;
    div.onclick = () => selectEmail(e.id);
    container.appendChild(div);
   });
  }

  function selectEmail(id) {
   const e = state.emails.find(x => x.id === id);
   if (!e) return;
   state.selected = e;
   if (!state.read.includes(e.id)) {state.read.push(e.id); localStorage.setItem('crc_read_' + roll, JSON.stringify(state.read));}
   document.getElementById('mailViewer').classList.remove('empty');
   document.getElementById('mailViewer').innerHTML = `<h2>${escapeHtml(e.subject)}</h2><div class="meta">From: ${escapeHtml(e.sender)} • ${escapeHtml(e.timestamp)}</div><div>${e.body}</div>`;
   document.getElementById('userInfo').textContent = roll + ' — ' + (localStorage.getItem('crc_name') || 'Student');
  }

  document.getElementById('search').addEventListener('input', (ev) => renderList(ev.target.value));
  document.getElementById('logout').addEventListener('click', () => {localStorage.removeItem('crc_token'); localStorage.removeItem('crc_roll'); window.location.href = '/';});
  document.getElementById('refreshBtn').addEventListener('click', fetchEmails);
  document.getElementById('markBtn').addEventListener('click', () => {
   if (!state.selected) return alert('Select an email first');
   const idx = state.read.indexOf(state.selected.id);
   if (idx !== -1) state.read.splice(idx, 1); else state.read.push(state.selected.id);
   localStorage.setItem('crc_read_' + roll, JSON.stringify(state.read));
   renderList(document.getElementById('search').value);
  });
  document.getElementById('openModal').addEventListener('click', () => {
   if (!state.selected) return alert('Select an email first');
   openModal(state.selected);
  });

  function openModal(e) {
   const root = document.getElementById('modalRoot');
   root.style.display = 'block';
   root.innerHTML = `<div class="modal"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center"><h3>${escapeHtml(e.subject)}</h3><button id="closeModal" class="muted-btn">Close</button></div><div style="color:var(--muted);margin-bottom:8px">From: ${escapeHtml(e.sender)} • ${escapeHtml(e.timestamp)}</div><div>${e.body}</div></div></div>`;
   document.getElementById('closeModal').onclick = () => {root.style.display = 'none'; root.innerHTML = '';};
  }

  function escapeHtml(s) {return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');}

  fetchEmails();
 </script>
</body>

</html>